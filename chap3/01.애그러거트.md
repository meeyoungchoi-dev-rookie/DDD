# 애그리거트

## 애그리거트

- 온라인 쇼핑몰을 개발한다면 상위 수준 개념을 사용하여 전체 모델을 정리하면 관계를 이해하는 데 도움이 된다
- 주문은 회원 , 상품 , 결제와 관련이 있다는 것을 파악할 수 있다

![애그리거트_상위수준에서 모델정리](https://user-images.githubusercontent.com/42866800/159449459-2cc15aa8-6d86-4658-b00c-f5fd2d741f59.png)

## 상위 수준 모델을 객체로 다시 그리기

- 상위 모델에 대한 이해없이 개별 객체 모델만 보고 상위 수준에서 개념을 파악하려면 시가닝 오래 걸린다
- 더 많은 코드를 보고 도메인 전문가와 많은 대화를 나눠야 상위 수준에서 모델 간의 관계가 이해되기 시작한다
- 도메인 객체 모델이 복잡해 지면 개별 구성요소 위주로 모델을 이해하게 되고 전반적인 구조나 큰 수준에서 도메인 간의 관계를 파악하기 어려워 진다
- 이는 곧 코드를 변경하고 확장해 나가는 것이 어려워진다는 것을 의미한다

![개별 객체 수준으로 쇼핑몰 모델을 바라봤을때](https://user-images.githubusercontent.com/42866800/159449529-2057cabf-695e-4ace-ac70-2a85689aa00f.png)

- 상위 수준에서 모델이 어떻게 역여 있는지 알아야 전체 모델을 망가뜨리지 않으면서 추가 요구사항을 모델에 반영할 수 있다
- 세부적인 모델만 이해한 상태로는 코드를 수정하기가 두렵기 때문에 코드 변경을 최대한 회피하는 쪽으로 요구사항을 협의하게 된다
- 이는 장기적인 관점에서 코드를 더 수정하기 어렵게 만들기도 한다

### 상위 수준에서 모델을 조망할 수 있는 방법

- `애그리거트` - 관련된 객체를 하나의 군으로 묶어준다
- 수많은 객체를 애그리거트로 묶어서 바라보면 상위 수준에서 도메인 모델간 관계를 파악할 수 있다
- 애그리거트를 사용함으로써 모델 간 관계를 개별 모델 수준뿐만 아니라 상위 수준에서도 이해할 수 있게 된다

![쇼핑몰을 애그리거트로 모델링](https://user-images.githubusercontent.com/42866800/159449654-fb4c9d13-1c6f-4995-bd9c-d17fffc8b3a5.png)

- 애그리거트는 일관성을 관리하는데 기준이 된다
- 애그리거트 단위로 일관성을 관리하기 때문에 애그리거트는 복잡한 도메인을 단순한 구조로 만들어 준다

<aside>
📌 복잡도가 낮아지는 만큼 도메인 기능을 확장하고 변경하는 데 필요한 노력도 줄어든다

</aside>

### 애그리거트 특징

- **애그리거트에 속한 객체는 유사하거나 동일한 라이프사이클을 갖는다**
- 예)
- 주문 애그리거트를 만들려면 주문과 관련된 Orderer , OrderLine , Order 객체를 함께 생성해야 한다
- Orderer는 생성했는데 ShippingInfo는 만들지 않았거나 ShippingInfo를 생성하면서 Orderer를 생성하지 않는 경우는 없다
- 도메인 규칙에 따라 최초 주문 시점에 일부 객체를 만들 필요가 없는 경우도 있지만
- 애그리거트에 속한 구성요소는 대부분 함께 생성하고 함께 제거한다

- **애그리거트는 경계를 갖는다**
- 한 애그리거트에 속한 객체는 다른 애그리거트에 속하지 않는다
- 애그리거트는 독립된 객체 군이며 각 애그리거트는 자기 자신을 관리할 뿐 다른 애그리거트를 관리하지 않는다
- 예)
- 주문 애그리거트는 배송지를 변경하거나 주문 상품 개수를 변경하는 등 자기 자신을 관리하지만 주문 애그리거트에서 회원의
- 비밀번홀르 변경하거나 상품의 가격을 변경하지 않는다

- **경계를 설정할 때 기본이 되는 것은 도메인 규칙과 요구사항이다**
- **도메인 규칙에 따라 함께 생성되는 구성요소는 한 애그리거트에 속할 가능성이 높다**
- 예)
- 주문할 상품 개수 , 배송지 정보  ,주문자 정보는 주문 시점에 함께 생성되므로 이들은 한 애그리거트에 속한다
- OrderLine 주문내역에서 주문상품 개수를 변경하면 도메인 규칙에 따라 Orderer의 총 주문 금액을 새로 계산해야 한다
- 사용자 요구사항에 따라 주문 상품 개수와 배송지를 함께 변경하기도 한다
- 함께 변경되는 빈도가 높은 객체는 한 애그리거트에 속할 가능성이 높다

- 예)
- 상품 상세 페이지에 들어가면 상품 상세 정보와 함께 리뷰 내용을 보여줘야 한다면
- Product 엔티티와 Review 엔티티가 한 애그리거트에 속한다고 생각할 수 있다
- 하지만 , Product와 Review는 함께 생성되지 않고 함께 변경되지도 않는다
- 또한 Product를 변경하는 주체가 상품 담당자 라면 Review를 생성하고 변경하는 주체는 고객이다
- Review의 변경이 Product에 영향을 주지 않고 Product의 변경이 Review에 영향을 주지 않기 때문에 서로 다른 애그리거트에 속한다

![한 애그리거트에 속하지 않는 경우](https://user-images.githubusercontent.com/42866800/159449704-8d42fcb1-9bcb-458e-a189-8f384bee39da.png)


<aside>
📌 다수의 애그리거트가 한 개의 엔티티 객체만 갖는 경우가 많으며 두 개 이상의 엔티티로 구성되는 에그리거트는 드물게 존재한다

</aside>

### 블로그 프로젝트에 애그리거트를 적용할 수 있는 방법

- 블로그에 필요한 최상위 기능을 상위 수준 모델로 그리기
- 상위 수준 모델을 클래스 단위 하위 모델로 분류해 보기
- 상위 수준과 하위 모델을 애그리거트를 사용하여 경계를 만들기
- 관련된 객체 끼리 하나의 군으로 묶기